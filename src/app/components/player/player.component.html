<!-- Sólo mostrar el reproductor si hay una canción -->
@if (currentSong()) {
  <div class="player-wrapper" 
       [class.minimized]="isMinimized()"
       [class.sidebar-collapsed]="sidebarCollapsed">
    <div class="player-container" 
         [class.playing]="isPlaying()" 
         [class.has-error]="hasError()">

      <!-- Toggle minimize button (desktop) -->
      @if (!isMobileView()) {
        <button
          class="minimize-toggle"
          type="button"
          (click)="toggleMinimize()"
          [attr.aria-label]="isMinimized() ? 'Expandir reproductor' : 'Minimizar reproductor'">
          <span class="material-icons">
            {{ isMinimized() ? 'expand_less' : 'expand_more' }}
          </span>
        </button>
      }

      <!-- Expand button (mobile) -->
      @if (isMobileView()) {
        <button
          class="mobile-expand"
          type="button"
          (click)="openMobileExpanded()"
          aria-label="Abrir reproductor completo">
          <span class="material-icons">expand_less</span>
        </button>
      }

      <!-- Error banner -->
      @if (hasError()) {
        <div class="error-banner">
          <span class="material-icons">error_outline</span>
          <span>{{ errorMessage() }}</span>
        </div>
      }

      <!-- Buffering indicator -->
      @if (isBuffering()) {
        <div class="buffering-indicator">
          <span class="material-icons spinning">refresh</span>
          <span>Cargando...</span>
        </div>
      }

      <!-- Album Art -->
      <div class="player-artwork">
        <div class="artwork-wrapper">
          <img
            [src]="getThumbnailUrl()"
            [alt]="getSongTitle()"
            loading="lazy" />
        </div>
      </div>

      <!-- Song Info -->
      <div class="player-info">
        <h3 class="title">{{ getSongTitle() }}</h3>
        <p class="artist">{{ getSongArtist() }}</p>
      </div>

      <!-- Action buttons (like, options) -->
      <div class="action-buttons">
        <button
          class="action-btn like-btn"
          [class.active]="isLiked()"
          (click)="onLikeToggle()"
          [disabled]="!currentSong()"
          [attr.aria-label]="isLiked() ? 'Quitar me gusta' : 'Me gusta'">
          <span class="material-icons">
            {{ isLiked() ? 'favorite' : 'favorite_border' }}
          </span>
        </button>

        <button
          class="action-btn options-btn"
          (click)="onOptionsClick($event)"
          [disabled]="!currentSong()"
          [attr.aria-label]="'Más opciones'">
          <span class="material-icons">more_vert</span>
        </button>
      </div>

      <!-- Playback controls -->
      <div class="playback-controls">
        <button
          class="control-btn prev-btn"
          (click)="onPrevious()"
          [disabled]="!hasPrevious()"
          [attr.aria-label]="'Anterior'">
          <span class="material-icons">skip_previous</span>
        </button>

        <button
          class="control-btn play-pause"
          (click)="onPlayPause()"
          [disabled]="!currentSong()"
          [attr.aria-label]="isPlaying() ? 'Pausar' : 'Reproducir'">
          <span class="material-icons">{{ isPlaying() ? 'pause' : 'play_arrow' }}</span>
        </button>

        <button
          class="control-btn next-btn"
          (click)="onNext()"
          [disabled]="!hasNext()"
          [attr.aria-label]="'Siguiente'">
          <span class="material-icons">skip_next</span>
        </button>
      </div>

      <!-- Volume Control (desktop only) -->
      <div class="volume-section">
        <button
          class="control-btn volume-btn"
          (click)="onMuteToggle()"
          [attr.aria-label]="isMuted() ? 'Activar sonido' : 'Silenciar'">
          <span class="material-icons">
            {{ isMuted() ? 'volume_off' : volume() > 50 ? 'volume_up' : 'volume_down' }}
          </span>
        </button>

        <div class="volume-slider-container">
          <div class="volume-track">
            <div class="volume-fill" [style.width.%]="volume()"></div>
          </div>
          <input
            type="range"
            class="volume-slider"
            [value]="volume()"
            (input)="onVolumeChange($event)"
            min="0"
            max="100"
            step="1"
            aria-label="Control de volumen" />
        </div>
      </div>

      <!-- Progress Bar (mobile/tablet only) -->
      <div class="progress-section">
        <span class="time time-elapsed">{{ timeElapsed() }}</span>

        <div class="seek-container">
          <div class="progress-track">
            <div class="progress-fill" [style.width.%]="progress()"></div>
            <div class="progress-handle" [style.left.%]="progress()"></div>
          </div>
          <input
            type="range"
            class="seek-bar"
            [value]="progress()"
            [disabled]="!currentSong()"
            (input)="onSeek($event)"
            min="0"
            max="100"
            step="0.1"
            aria-label="Barra de progreso" />
        </div>

        <span class="time time-total">{{ timeTotal() }}</span>
      </div>
      </div>
    </div>
  }

  @if (showMobileOverlay()) {
    <div class="mobile-expanded-backdrop" (click)="closeMobileExpanded()">
      <div class="mobile-expanded-container" (click)="onMobileContainerClick($event)">
        <div class="mobile-expanded-header">
          <button
            type="button"
            class="mobile-collapse-btn"
            (click)="closeMobileExpanded()"
            aria-label="Cerrar reproductor">
            <span class="material-icons">expand_more</span>
          </button>

          <div class="mobile-header-info">
            <span class="title" [title]="getSongTitle()">{{ getSongTitle() }}</span>
            <span class="artist" [title]="getSongArtist()">{{ getSongArtist() }}</span>
          </div>

          <div class="mobile-menu">
            <button
              type="button"
              class="mobile-menu-btn"
              (click)="toggleMobileMenu($event)"
              aria-haspopup="true"
              [attr.aria-expanded]="isMobileMenuOpen()">
              <span class="material-icons">more_vert</span>
            </button>

            @if (isMobileMenuOpen()) {
              <div class="mobile-menu-dropdown" role="menu" (click)="$event.stopPropagation()">
                <button type="button" (click)="closeMobileExpanded()">Volver al mini reproductor</button>
              </div>
            }
          </div>
        </div>

        <div class="mobile-artwork">
          <img
            [src]="getThumbnailUrl()"
            [alt]="getSongTitle()"
            loading="lazy" />
        </div>

        <div class="mobile-track-details">
          <div class="mobile-track-texts">
            <h3 class="title">{{ getSongTitle() }}</h3>
            <p class="artist">{{ getSongArtist() }}</p>
          </div>

          <button
            type="button"
            class="mobile-like-btn"
            [class.active]="isLiked()"
            (click)="onLikeToggle()"
            [disabled]="!currentSong()"
            [attr.aria-label]="isLiked() ? 'Quitar me gusta' : 'Me gusta'">
            <span class="material-icons">{{ isLiked() ? 'favorite' : 'favorite_border' }}</span>
          </button>
        </div>

        <div class="mobile-progress">
          <span class="time">{{ timeElapsed() }}</span>
          <input
            type="range"
            class="mobile-seek"
            [value]="progress()"
            [disabled]="!currentSong()"
            (input)="onSeek($event)"
            min="0"
            max="100"
            step="0.1"
            aria-label="Barra de progreso móvil" />
          <span class="time">{{ timeTotal() }}</span>
        </div>

        <div class="mobile-controls">
          <button
            type="button"
            class="control-btn prev-btn"
            (click)="onPrevious()"
            [disabled]="!hasPrevious()"
            aria-label="Anterior">
            <span class="material-icons">skip_previous</span>
          </button>

          <button
            type="button"
            class="control-btn play-pause"
            (click)="onPlayPause()"
            [disabled]="!currentSong()"
            [attr.aria-label]="isPlaying() ? 'Pausar' : 'Reproducir'">
            <span class="material-icons">{{ isPlaying() ? 'pause' : 'play_arrow' }}</span>
          </button>

          <button
            type="button"
            class="control-btn next-btn"
            (click)="onNext()"
            [disabled]="!hasNext()"
            aria-label="Siguiente">
            <span class="material-icons">skip_next</span>
          </button>
        </div>

        <div class="mobile-volume">
          <button
            type="button"
            class="volume-btn"
            (click)="onMuteToggle()"
            [attr.aria-label]="isMuted() ? 'Activar sonido' : 'Silenciar'">
            <span class="material-icons">
              {{ isMuted() ? 'volume_off' : volume() > 50 ? 'volume_up' : 'volume_down' }}
            </span>
          </button>

          <input
            type="range"
            class="volume-slider"
            [value]="volume()"
            (input)="onVolumeChange($event)"
            min="0"
            max="100"
            step="1"
            aria-label="Volumen" />
        </div>
      </div>
    </div>
  </div>

  @if (showMobileOverlay()) {
    <div class="mobile-expanded-backdrop" (click)="closeMobileExpanded()">
      <div class="mobile-expanded-container" (click)="onMobileContainerClick($event)">
        <div class="mobile-expanded-header">
          <button
            type="button"
            class="mobile-collapse-btn"
            (click)="closeMobileExpanded()"
            aria-label="Cerrar reproductor">
            <span class="material-icons">expand_more</span>
          </button>

          <div class="mobile-header-info">
            <span class="title" [title]="getSongTitle()">{{ getSongTitle() }}</span>
            <span class="artist" [title]="getSongArtist()">{{ getSongArtist() }}</span>
          </div>

          <div class="mobile-menu">
            <button
              type="button"
              class="mobile-menu-btn"
              (click)="toggleMobileMenu($event)"
              aria-haspopup="true"
              [attr.aria-expanded]="isMobileMenuOpen()">
              <span class="material-icons">more_vert</span>
            </button>

            @if (isMobileMenuOpen()) {
              <div class="mobile-menu-dropdown" role="menu" (click)="$event.stopPropagation()">
                <button type="button" (click)="closeMobileExpanded()">Volver al mini reproductor</button>
              </div>
            }
          </div>
        </div>

        <div class="mobile-artwork">
          <img
            [src]="getThumbnailUrl()"
            [alt]="getSongTitle()"
            loading="lazy" />
        </div>

        <div class="mobile-track-details">
          <div class="mobile-track-texts">
            <h3 class="title">{{ getSongTitle() }}</h3>
            <p class="artist">{{ getSongArtist() }}</p>
          </div>

          <button
            type="button"
            class="mobile-like-btn"
            [class.active]="isLiked()"
            (click)="onLikeToggle()"
            [disabled]="!currentSong()"
            [attr.aria-label]="isLiked() ? 'Quitar me gusta' : 'Me gusta'">
            <span class="material-icons">{{ isLiked() ? 'favorite' : 'favorite_border' }}</span>
          </button>
        </div>

        <div class="mobile-progress">
          <span class="time">{{ timeElapsed() }}</span>
          <input
            type="range"
            class="mobile-seek"
            [value]="progress()"
            [disabled]="!currentSong()"
            (input)="onSeek($event)"
            min="0"
            max="100"
            step="0.1"
            aria-label="Barra de progreso móvil" />
          <span class="time">{{ timeTotal() }}</span>
        </div>

        <div class="mobile-controls">
          <button
            type="button"
            class="control-btn prev-btn"
            (click)="onPrevious()"
            [disabled]="!hasPrevious()"
            aria-label="Anterior">
            <span class="material-icons">skip_previous</span>
          </button>

          <button
            type="button"
            class="control-btn play-pause"
            (click)="onPlayPause()"
            [disabled]="!currentSong()"
            [attr.aria-label]="isPlaying() ? 'Pausar' : 'Reproducir'">
            <span class="material-icons">{{ isPlaying() ? 'pause' : 'play_arrow' }}</span>
          </button>

          <button
            type="button"
            class="control-btn next-btn"
            (click)="onNext()"
            [disabled]="!hasNext()"
            aria-label="Siguiente">
            <span class="material-icons">skip_next</span>
          </button>
        </div>

        <div class="mobile-volume">
          <button
            type="button"
            class="volume-btn"
            (click)="onMuteToggle()"
            [attr.aria-label]="isMuted() ? 'Activar sonido' : 'Silenciar'">
            <span class="material-icons">
              {{ isMuted() ? 'volume_off' : volume() > 50 ? 'volume_up' : 'volume_down' }}
            </span>
          </button>

          <input
            type="range"
            class="volume-slider"
            [value]="volume()"
            (input)="onVolumeChange($event)"
            min="0"
            max="100"
            step="1"
            aria-label="Volumen" />
        </div>
      </div>
    </div>
  }
}
